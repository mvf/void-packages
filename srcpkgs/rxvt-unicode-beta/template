# Template build file for 'rxvt-unicode-beta'.
pkgname=rxvt-unicode-beta
_gitrev=da0c24912d85dc3ecbf9dac2a12c60e197acc8f4
version="${_gitrev:0:7}"
conflicts="${pkgname%*-beta}"
wrksrc="${pkgname%*-beta}-${_gitrev}"
revision=1
build_style=gnu-configure
configure_args="
 --with-terminfo=/usr/share/terminfo --enable-256-color
 --enable-font-styles --enable-xim --enable-keepscrolling
 --enable-selectionscrolling --enable-smart-resize --enable-transparency
 --disable-utmp --disable-wtmp --disable-lastlog --disable-frills
 --enable-combining --with-term=rxvt-unicode-256color"
hostmakedepends="pkg-config"
makedepends="xorgproto fontconfig-devel libXrender-devel libXft-devel libSM-devel"
depends="ncurses rxvt-unicode-terminfo-beta-${version}_${revision}"
short_desc="Terminal emulator supporting Xft fonts and Unicode"
maintainer="Juan RP <xtraeme@voidlinux.eu>"
homepage="http://software.schmorp.de/pkg/rxvt-unicode.html"
license="GPL-2"
mutable_files="
 /usr/share/terminfo/r/rxvt-unicode
 /usr/share/terminfo/r/rxvt-unicode-256color
"
distfiles="
 https://github.com/exg/rxvt-unicode/archive/${_gitrev}.tar.gz
 http://dist.schmorp.de/libev/libev-4.33.tar.gz
 http://dist.schmorp.de/libptytty/libptytty-1.8.tar.gz
"
checksum="
 1b9fa853ef9573ff0425ada08f972301f170ae4980495a20234926852c85e822
 507eb7b8d1015fbec5b935f34ebed15bf346bed04a11ab82b8eee848c4205aea
 cb307f82bc0001cb7d6a374eb47f1412bad91f907adb4ddcc7653ae1634dcc2f
"

pre_build() {
	sed -i 's,/usr/bin/tic,/bin/true,g' doc/Makefile
}

post_install() {
	vinstall doc/etc/rxvt-unicode.terminfo 644 usr/share/terminfo/r
	vinstall ${FILESDIR}/${pkgname%*-beta}.desktop 644 usr/share/applications
	vinstall ${FILESDIR}/${pkgname%*-beta}.png 644 usr/share/pixmaps
}

# Package build options
build_options="gdk_pixbuf perl startup_notification unicode3"
desc_option_unicode3="Use 21 instead of 16 bits to represent unicode chars"

# Enable startup-notification by default.
build_options_default="perl startup_notification unicode3"

if [ "$build_option_gdk_pixbuf" ]; then
	configure_args+=" --enable-pixbuf"
	makedepends+=" gdk-pixbuf-devel"
else
	configure_args+=" --disable-pixbuf"
fi

if [ "$build_option_perl" ]; then
	configure_args+=" --enable-perl"
	hostmakedepends+=" perl autoconf"
	makedepends+=" perl"
else
	configure_args+=" --disable-perl"
fi

if [ "$build_option_startup_notification" ]; then
	configure_args+=" --enable-startup-notification"
	makedepends+=" startup-notification-devel"
else
	configure_args+=" --disable-startup-notification"
fi

if [ "$build_option_unicode3" ]; then
	configure_args+=" --enable-unicode3"
else
	configure_args+=" --disable-unicode3"
fi

_cross_perl() {
	if [ "$CROSS_BUILD" ]; then
		sed -e "s#/usr/lib#${XBPS_CROSS_BASE}\0#g" \
			-e "s#/usr/share#${XBPS_CROSS_BASE}\0#g" \
			-e "s# -m[^ ]*##g"
	else
		cat
	fi
}

pre_configure() {
	ln -s ../libev-* libev
	ln -s ../libptytty-* libptytty
	./autogen.sh
	# sed -i 's/^.*libev.*$//gI' configure.ac
	# autoheader
	# autoconf
	# rm -rf autom4te.cache/
}

do_configure() {
	if [ "$build_option_perl" ]; then
		./configure $configure_args \
			PERL=perl \
			PERL_O=rxvtperl.o \
			PERLFLAGS="$(perl -MExtUtils::Embed -e ccopts | _cross_perl)" \
			PERLLIB="$(perl -MExtUtils::Embed -e ldopts | _cross_perl)" \
			PERLPRIVLIBEXP="$(perl -MConfig -e 'print $Config{privlibexp}' | _cross_perl)"
	else
		./configure $configure_args
	fi
}

rxvt-unicode-terminfo-beta_package() {
	short_desc+=" - terminfo data"
	conflicts="${pkgname%*-beta}"
	noarch=yes
	pkg_install() {
		vmove usr/share/terminfo
	}
}
